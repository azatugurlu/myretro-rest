DROP DATABASE IF EXISTS MYRETROAPPDB;

CREATE DATABASE IF NOT EXISTS MYRETROAPPDB DEFAULT CHARACTER SET 'utf8mb4';

use MYRETROAPPDB;

CREATE TABLE IF NOT EXISTS oauth_client_details (
CLIENT_ID VARCHAR(255) NOT NULL PRIMARY KEY,
CLIENT_SECRET VARCHAR(255) NOT NULL,
RESOURCE_IDS VARCHAR(255) DEFAULT NULL,
SCOPE VARCHAR(255) DEFAULT NULL,
AUTHORIZED_GRANT_TYPES VARCHAR(255) DEFAULT NULL,
WEB_SERVER_REDIRECT_URI VARCHAR(255) DEFAULT NULL,
AUTHORITIES VARCHAR(255) DEFAULT NULL,
ACCESS_TOKEN_VALIDITY INT(11) DEFAULT NULL,
REFRESH_TOKEN_VALIDITY INT(11) DEFAULT NULL,
ADDITIONAL_INFORMATION VARCHAR(4096) DEFAULT NULL,
AUTOAPPROVE VARCHAR(255) DEFAULT NULL);
 
 INSERT INTO oauth_client_details (
	CLIENT_ID,
    CLIENT_SECRET,
	RESOURCE_IDS,
	SCOPE,
	AUTHORIZED_GRANT_TYPES,
	WEB_SERVER_REDIRECT_URI,AUTHORITIES,
	ACCESS_TOKEN_VALIDITY,REFRESH_TOKEN_VALIDITY,
	ADDITIONAL_INFORMATION,AUTOAPPROVE)
	VALUES(
    'USER_WEB_APP','{bcrypt}$2a$10$iDXkxyBB5bhV9zvG2sHql.zBf2m3xxkICuMteZPtACZomlkRchCW2',
	'USER_CLIENT_RESOURCE,USER_ADMIN_RESOURCE',
	'role_admin,role_user',
	'authorization_code,password,refresh_token,implicit',
	NULL,NULL,
	99999999,99999999,
	'{}',NULL),
	(
    'USER_MOBILE_APP','{bcrypt}$2a$10$.MH9Y6GBKWRGQCYTJZQHnObdM/Smt/rUWXYT30nX/rsGlijr.SIyC',
	'USER_CLIENT_RESOURCE,USER_ADMIN_RESOURCE',
	'role_admin,role_user',
	'authorization_code,password,refresh_token,implicit',
	NULL,NULL,
	4800,7200,
	'{}',NULL);
 
 
 
CREATE TABLE IF NOT EXISTS permission (
	ID BINARY(16) PRIMARY KEY,
	NAME VARCHAR(60) UNIQUE KEY,
	TITLE VARCHAR(60),
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP ,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO permission (ID,NAME, TITLE,CREATE_DATE,CREATE_BY) VALUES 
(unhex('682E70AA770011E9816C443C602DC03D'),'can_manage_user', 'Can Manage Users', NOW(),'Super Admin Manuel'),
(unhex('ba2a1c91ebed4af7b5891aa9113d174a'),'can_assign_role_to_user', 'Can Assign User Role', NOW(),'Super Admin Manuel'),
(unhex('682E6F92770011E9816C443C602DC03D'),'can_manage_role', 'Can Manage Role', NOW(),'Super Admin Manuel'),
(unhex('9030546ef7a446faab3ee31513f724f7'),'can_read_role', 'Can Read Role', NOW(),'Super Admin Manuel'),
(unhex('682E7154770011E9816C443C602DC03D'),'can_manage_permission', 'Can Manage Permissions', NOW(),'Super Admin Manuel'),
(unhex('682E71AE770011E9816C443C602DC03D'),'can_assign_permission_to_role', 'Can Assign Permission to Role', NOW(),'Super Admin Manuel');


CREATE TABLE IF NOT EXISTS role (
	ID BINARY(16) PRIMARY KEY, 
	NAME VARCHAR(60) UNIQUE KEY,
	TITLE VARCHAR(60),
	STATUS TINYINT(1) default '1',
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


INSERT INTO role (ID, NAME, TITLE, CREATE_DATE, CREATE_BY, STATUS) VALUES 
(unhex('682FA0BA770011E9816C443C602DC03D'),'role_admin', 'Admin', NOW(),'Super Admin Manuel', 1),
(unhex('682F9F2A770011E9816C443C602DC03D'),'role_user', 'User', NOW(),'Super Admin Manuel', 1);


CREATE TABLE IF NOT EXISTS permission_role(
	ID BINARY(16) PRIMARY KEY,
	PERMISSION_ID BINARY(16),
	ROLE_ID BINARY(16),
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP ,
	UPDATE_BY VARCHAR(80),
	FOREIGN KEY(PERMISSION_ID) REFERENCES permission(ID),
	FOREIGN KEY(ROLE_ID) REFERENCES role(ID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO permission_role (ID,PERMISSION_ID, ROLE_ID,CREATE_DATE,CREATE_BY) VALUES 
(unhex(replace(uuid(),'-','')),unhex('682E70AA770011E9816C443C602DC03D'),unhex('682FA0BA770011E9816C443C602DC03D'), NOW(),'Super Admin Manuel'),
(unhex(replace(uuid(),'-','')),unhex('682E6F92770011E9816C443C602DC03D'),unhex('682FA0BA770011E9816C443C602DC03D'), NOW(),'Super Admin Manuel'),
(unhex(replace(uuid(),'-','')),unhex('682E7154770011E9816C443C602DC03D'),unhex('682FA0BA770011E9816C443C602DC03D'), NOW(),'Super Admin Manuel'),
(unhex(replace(uuid(),'-','')),unhex('682E71AE770011E9816C443C602DC03D'),unhex('682FA0BA770011E9816C443C602DC03D'), NOW(),'Super Admin Manuel'),
(unhex(replace(uuid(),'-','')),unhex('ba2a1c91ebed4af7b5891aa9113d174a'),unhex('682FA0BA770011E9816C443C602DC03D'), NOW(),'Super Admin Manuel');



CREATE TABLE IF NOT EXISTS user_account_information (
	ID BINARY(16) PRIMARY KEY,
	EMAIL_VERIFICATION_STATUS TINYINT NOT NULL default '0',
    EMAIL_APPROVE_DATE TIMESTAMP,
	PHONE_VERIFICATION_STATUS TINYINT NOT NULL default '0',
    PHONE_APPROVE_DATE TIMESTAMP,
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO user_account_information (ID,EMAIL_VERIFICATION_STATUS,PHONE_VERIFICATION_STATUS,CREATE_DATE,CREATE_BY) VALUES
(unhex('97d6b91607df4f7f848e1faebeec17af'),0,0,NOW(),'Super Admin Manuel'),
(unhex('e893a7f1dbc44111bf48a31aa926ba06'),0,0,NOW(),'Super Admin Manuel'),
(unhex('4f327dcbe03b482caeb7bc141b301528'),0,0,NOW(),'Super Admin Manuel'),
(unhex('04035a1aea9a4f508be789de996c098c'),0,0,NOW(),'Super Admin Manuel'),
(unhex('c80f7a08d001484b84bf2a3c56f17543'),0,0,NOW(),'Super Admin Manuel');


CREATE TABLE IF NOT EXISTS user (
	ID BINARY(16) PRIMARY KEY,
	USERNAME VARCHAR(100) UNIQUE KEY NOT NULL,
	PHONE VARCHAR(24) UNIQUE KEY NOT NULL,
	PASSWORD VARCHAR(255) NOT NULL,
	FIRSTNAME VARCHAR(100) NOT NULL,
	LASTNAME VARCHAR(100) NOT NULL,
	USER_ACCOUNT_INFORMATION_ID BINARY(16) NOT NULL,
	IS_TFA_ENABLED VARCHAR(1),
	TFA_DEFAULT_TYPE VARCHAR(10),
	ENABLED BIT(1) NOT NULL,
	ACCOUNT_EXPIRED BIT(1) NOT NULL,
	CREDENTIALS_EXPIRED BIT(1) NOT NULL,
	ACCOUNT_LOCKED BIT(1) NOT NULL,	
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80),
	FOREIGN KEY(USER_ACCOUNT_INFORMATION_ID) REFERENCES user_account_information(ID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO user (ID,USERNAME,PHONE,PASSWORD,FIRSTNAME,LASTNAME,USER_ACCOUNT_INFORMATION_ID,IS_TFA_ENABLED,TFA_DEFAULT_TYPE,ENABLED,ACCOUNT_EXPIRED,CREDENTIALS_EXPIRED,ACCOUNT_LOCKED,CREATE_DATE,CREATE_BY) VALUES (
unhex('b2afd9a01c8e4ec8a8ce42baa4fee151'),'admin@example.org', '+35840123456788','{bcrypt}$2a$12$LsD0Ytt6hYj43bqHTKrHluN66WFfmMAGXHU9.NqROg/mI7.COH/8m',
'admin', 'adminLastName',unhex('97d6b91607df4f7f848e1faebeec17af'),'n','email',1,0,0,0, NOW(),'Super Admin Manuel'),
(unhex('dac8458f6ea140568d555bb2fdea53e3'),'user@example.org', '+35840123456789','{bcrypt}$2a$12$LsD0Ytt6hYj43bqHTKrHluN66WFfmMAGXHU9.NqROg/mI7.COH/8m',
'user', 'userLastName',unhex('4f327dcbe03b482caeb7bc141b301528'),'n','email',1,0,0,0, NOW(),'Super Admin Manuel');



CREATE TABLE IF NOT EXISTS tfa_token (
ID BINARY(16) PRIMARY KEY,
TOKEN VARCHAR(36) UNIQUE KEY NOT NULL,
USER_ID BINARY(16), FOREIGN KEY(USER_ID) REFERENCES user(ID),
EXPIRY_DATE TIMESTAMP NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS role_user (
	ID BINARY(16) PRIMARY KEY ,
	ROLE_ID BINARY(16),FOREIGN KEY(ROLE_ID) REFERENCES role(ID),
	USER_ID BINARY(16), FOREIGN KEY(USER_ID) REFERENCES user(ID),
	CONSTRAINT UC_relation UNIQUE (ROLE_ID,USER_ID)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


INSERT INTO role_user (ID,ROLE_ID, USER_ID)
VALUES 
(unhex(replace(uuid(),'-','')),unhex('682FA0BA770011E9816C443C602DC03D'), unhex('b2afd9a01c8e4ec8a8ce42baa4fee151')),
(unhex(replace(uuid(),'-','')),unhex('682F9F2A770011E9816C443C602DC03D'), unhex('dac8458f6ea140568d555bb2fdea53e3'));

CREATE TABLE IF NOT EXISTS token_operation (
ID BINARY(16) PRIMARY KEY,
TOKEN VARCHAR(36) UNIQUE KEY NOT NULL,
OPERATION_TYPE VARCHAR(10) NOT NULL,
USER_ID BINARY(16), FOREIGN KEY(USER_ID) REFERENCES user(ID),
EXPIRY_DATE TIMESTAMP NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE IF NOT EXISTS team (
	ID BINARY(16) PRIMARY KEY,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(255),
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS team_user (
	ID BINARY(16) PRIMARY KEY ,
	TEAM_ID BINARY(16),FOREIGN KEY(TEAM_ID) REFERENCES team(ID),
	USER_ID BINARY(16), FOREIGN KEY(USER_ID) REFERENCES user(ID),
	CONSTRAINT UC_relation UNIQUE (TEAM_ID,USER_ID)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE IF NOT EXISTS board (
	ID BINARY(16) PRIMARY KEY,
	TEAM_ID BINARY(16), FOREIGN KEY(TEAM_ID) REFERENCES team(ID),
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(255),
	BOARD_TYPE VARCHAR(80),
	RETRO_TYPE VARCHAR(80),
	GOAL_ACHIEVED TINYINT(1) default '0',
	RETRO_DATE TIMESTAMP,
	COUNT_DOWN_TIMER_START_DATE TIMESTAMP,
	COUNT_DOWN_TIMER_END_DATE TIMESTAMP,
	CREATE_DATE TIMESTAMP NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS board_column (
	ID BINARY(16) PRIMARY KEY,
	BOARD_ID BINARY(16), FOREIGN KEY(BOARD_ID) REFERENCES board(ID),
	NAME VARCHAR(100) NOT NULL,
	COLOR VARCHAR(16) NOT NULL,
	COLUMN_ORDER INT(11) NOT NULL,
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS board_row (
	ID BINARY(16) PRIMARY KEY,
	BOARD_ID BINARY(16), FOREIGN KEY(BOARD_ID) REFERENCES board(ID),
	COLUMN_ID BINARY(16), FOREIGN KEY(COLUMN_ID) REFERENCES board_column(ID),
	AUTHOR_NAME VARCHAR(80) NOT NULL,
	DESCRIPTION VARCHAR(255) NOT NULL,
	CREATE_DATE TIMESTAMP  NOT NULL,
	CREATE_BY VARCHAR(80) NOT NULL,
	UPDATE_DATE TIMESTAMP,
	UPDATE_BY VARCHAR(80)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS vote_user (
	ID BINARY(16) PRIMARY KEY ,
	BOARD_ROW_ID BINARY(16),FOREIGN KEY(BOARD_ROW_ID) REFERENCES board_row(ID),
	USER_ID BINARY(16), FOREIGN KEY(USER_ID) REFERENCES user(ID),
	AUTHOR_NAME VARCHAR(80) NOT NULL,
	CONSTRAINT UC_relation UNIQUE (BOARD_ROW_ID,USER_ID)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

